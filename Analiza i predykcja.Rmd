---
title: "Analiza i predykcja wieku w zale¿noœci od czynników wp³ywaj¹cych na kondycje serca"
author: "Ewa Bojke, Jaros³aw Kuczyñski"
date: "25 stycznia 2020"
output: html_document
---

#Zbiór danych

\newline
W naszym projekcie bêdziemy u¿ywali danych ze strony https://kaggle.com.
\newline
Ta baza danych zawiera 76 atrybutów, ale wszystkie opublikowane eksperymenty odnosz¹ siê do korzystania z podzbioru 14 z nich. W szczególnoœci baza danych Cleveland jest jedyn¹, z której do tej pory korzystali naukowcy ML.  

**Zmiennne**

zmienna       opis
--------      ----
`age`          wiek
`sex`          p³eæ
`cp`           indykator bólu w klatce piersiowej(od 0 do 1 wartoœci)
`trestbps`     spoczynkowe ciœnienie krwi
`chol`         surowica cholestoral w mg / dl
`fbs`          indykator czy cukier na czczo(0=nie, 1=tak)  
`restecg`      indykator spoczynkowych wyników elektrokar(0,1)
`thalach`      maksymalne osi¹gniête têtno
`exang`        indykator dusznicy bolesnej wywo³anej wysi³kiem                          fizycznym(0=nie,1=tak)
`oldpeak`      depresja ST wywo³ana wysi³kiem w stosunku do odpoczynku

      
\newline 
**Sformu³owanie problemu badawczego oraz agenda do zadañ **\newline
\newline

W naszym projekcie 

\newline

- przygotujemy dane do interpretacji tzw. czyszczenie danych i ich          wczytanie

- przeanalizujemy zmienne i zale¿noœci miêdzy nimi tzw. eksploracyjna       analiza danych\newline

- stworzymy model predykcyjny wieku osób chorych \newline

- sprawdzimy jaki model najbardziej pasuje do danych

\newline 

#Wczytywanie danych

```{r}
heart = read.csv("C:/Users/Ewci/Desktop/wnioskowanie II/projekt/heart.csv")
colnames(heart)=c('wiek', 'plec', 'bol', 'cisnienie','cholesterol', 'cukier','spo.wyn','max tetno','dusznica','depresja ST')
```

\newline 

#Zamiana odpowiednich zmiennych na czynniki

```{r}
library(dplyr)
heart <- heart %>% mutate(plec = factor(plec, levels = c(man=0, woman = 1), labels = c("man","woman"))) %>% mutate(cukier = factor(cukier, levels = c(cukrzyk= 1, zdrowy = 0), labels = c("cukrzyk", "zdrowy")))%>% mutate(dusznica = factor(dusznica, levels = c(dusznica= 1, `bez dusznicy` = 0),labels = c("dusznica", "bez dusznicy")))%>% mutate(spo.wyn = factor(spo.wyn, levels = c(duze= 1, `male` = 0),labels = c("duze", "male")))%>% mutate(bol = factor(bol, levels = c(bol= 1, `brak bolu` = 0),labels = c("bol", "brak bolu")))
```

Wnioski i obserwacje:

Zamieniliœmy zmienne numeryczne plec, cukier, dusznica, bol, spo.wyn na zmienne kategoryczne. U¿yjemy ich do analizy wariancji w kolejnych etapach projektu.

#Podstawowe statystyki dla zmiennych w naszym zbiorze danych

```{r}
lapply(heart,summary)
```
Wnioski i obserwacje:

Mo¿emy zaobserwowaæ, ¿e wiek badanych ludzi waha siê od 29 do 77 lat.
Przy czym po³owa ludzi ma wiek w przedziale 47.5 - 61 lat z
median¹ 55 lat. W badaniach mamy wiêcej kobiet ni¿ mê¿czyzn.

Jeœli chodzi o ciœnienie skurczowe  krwi, to mo¿emy zauwa¿yæ, ¿e wahania wystêpuj¹ miêdzy 94mm a 200mm. Wiêksza czêœæ badanych ma wyniki ciœnienia skurczowego miêdzy 120 a 140mm z median¹ 130mm. Ogólnie O nadciœnieniu mówimy ju¿ w momencie, gdy ciœnienie skurczowe przekracza 140 mm .

Natomiast wyniki cholesterolu u zdrowego cz³owieka nie powinny przekraczaæ 190mg. W naszych danych wahania wystêpuj¹ miêdzy 126mg a 409mg. Wiêkszoœæ badanych ma wyniki w przedziale 211 mg - 274.5mg. 

Ostatni¹ zmienn¹, któr¹ zbadamy to têtno. Wahania wystêpuj¹ miêdzy 71 a 202 uderzeñ serca na minutê. Wiêksza czêœæ osób ma têtno w  przedziale (134,166) z median¹ równ¹ 153. Wynikiem zagra¿aj¹cym zdrowiu jest przekroczenie 100 uderzeñ serca na minutê.



#Korelacje miêdzy zmiennymi
```{r}
cor(heart$cisnienie,heart$cholesterol)
cor(heart$cisnienie,heart$`max tetno`)
cor(heart$cholesterol,heart$`max tetno`)
cor(heart$cisnienie,heart$`depresja ST`)
cor(heart$cholesterol,heart$`depresja ST`)
cor(heart$`max tetno`,heart$`depresja ST`)

```

Wnioski i obserwacje:

Wiêkszoœæ zmiennych nie jest skorelowana. Jedynie mamy wiêksz¹ korelacjê przy zmiennych ciœnienie i depresja ST, przy zmiennych ciœnienie i cholesterol oraz przy zmiennych max tetno i depresja ST. Korelacja wynosi odpowiednio oko³o 0.2, 0.14 i -0.34.

#Przyk³adowe zale¿noœci miêdzy zmiennymi i modele liniowe dla zmiennych

```{r}
mod1=lm(heart$cholesterol~heart$cisnienie)
plot(heart$cisnienie,heart$cholesterol, xlab="Cisnienie krwi", ylab="Cholesterol")
abline(mod1,lwd=4,col='red')


mod2=lm(heart$`max tetno`~heart$cisnienie)
plot(heart$cisnienie, heart$`max tetno`, xlab="Cisnienie ", ylab="Max tetno")
abline(mod2,lwd=4,col="red")

mod3=lm(heart$`max tetno`~heart$cholesterol)
plot(heart$cholesterol,heart$`max tetno`, xlab="Cholesterol", ylab="Max tetno")
abline(mod3,lwd=4,col="red")

mod4=lm(heart$`depresja ST`~heart$cisnienie)
plot(heart$cisnienie,heart$`depresja ST`, xlab="Cisnienie",ylab="Depresja ST")
abline(mod4,lwd=4,col="red")

mod5=lm(heart$`depresja ST`~heart$cholesterol)
plot(heart$cholesterol,heart$`depresja ST`, xlab="Cholesterol", ylab="Depresja ST")
abline(mod5,lwd=4,col='red')

mod6=lm(heart$`depresja ST`~heart$`max tetno`)
plot(heart$`max tetno`,heart$`depresja ST`, xlab="Max tetno", ylab="Depresja ST")
abline(mod6,lwd=4,col='red')


```


Wnioski i obserwacje:

Widzimy,¿e jest zale¿noœæ miêdzy zmiennymi, ale bardzo ma³a.
Najwiêksz¹ zale¿noœæ mo¿emy zauwa¿yæ miêdzy zmiennymi depresja ST i max tetno.

\newpage
#Badanie zale¿noœci
```{r}
summary(mod1)
summary(mod2)
summary(mod3)
summary(mod4)
summary(mod5)
summary(mod6)
```

Wnioski i obserwacje:

Jak widaæ wiêkszoœæ zmiennych jest s³abo zale¿ne i  s¹ s³abo skorelowane.
Jedynie w ostanim modelu widzimy pewn¹ zale¿noœæ. B³¹d standardowy reszt wynosi w tym przypadku tylko 1.141. Mod6 wyjaœnia oko³o 11.5% wariancji depresji ST bior¹c pod uwagê maksymalne têtno.


#Modele w regresji wieloliniowej

Regresja wieloliniowa jest to wyjaœnianie wartoœci zmiennej zale¿nej za pomoc¹ wiêcej ni¿ jednego predyktora. 
Stworzymy model nie bior¹cy pod uwagê zale¿noœci pomiêdzy zmiennymi 

```{r}
model = lm(heart$wiek~+cholesterol+`max tetno`+cisnienie, heart)
summary(model)
```

Wnioski i obserwacje:

Ka¿dy wzrost o 1 mg cholesterolu sprawia, ¿e œrednia wartoœæ wieku   bêdzie wzrasta³a o 0.03 lat, czyli nieca³e 11 dni.(zak³adaj¹c, ¿e pozosta³e zmienne siê nie zmieniaj¹)

Ka¿dy wzrost o 1mm ciœnienia krwi sprawia, ¿e œrednia wartoœæ wieku bêdzie wzrasta³a o 0.12 lat, czyli nieca³e 44 dni.(zak³adaj¹c, ¿e pozosta³e zmienne siê nie zmieniaj¹)

Ka¿dy wzrost o 1 uderzenie serca na minutê sprawia, ¿e œrednia wartoœæ wieku bêdzie mala³a o 0.15lat, czyli nieca³e 54 dni.(zak³adaj¹c, ¿e pozosta³e zmienne siê nie zmieniaj¹)

Wspó³czynnik determinacji wynosi 0.2464. Natomiast b³¹d standardowy reszt 7.884. Model wyjaœnia 24% wariancji wieku. W wiêkszoœci wyników mamy tak¹ sytuacjê, ¿e osoby maj¹ce coraz s³absz¹ kondycjê serca s¹ starsze. Je¿eli osoby badane maj¹ podwy¿szone têtno to wyst¹pi to przewa¿nie w m³odszym wieku. 
 

Dodajemy zmienn¹ depresja ST i tworzymy model.
```{r}
model2ST = lm(heart$wiek~+cholesterol+`max tetno`+cisnienie+`depresja ST`, heart)
summary(model2ST)
```

Wnioski i obserwacje:

Tak jak wczeœniej widzimy przewa¿nie œredni wzrost zmiennej wiek. Zauwa¿my ¿e nowa zmienna zmniejszy³a wspó³czynnik determinacji, który teraz wynosi  0.2445 i zwiêkszy³a b³¹d standardowy reszt, który teraz wynosi 7.894. Mo¿emy powiedzieæ, ¿e ten model nie jest lepszy od poprzedniego. Depresja ST jest skorelowana z ciœnieniem i z max tetno i dlatego model zbytnio siê nie ró¿ni chocia¿ b³¹d standardowy reszt jest wiêkszy. Informacje, które s¹ przechowywane w zmiennej ciœnienie i max tetno zawiera równie¿ zmienna z nimi skorelowana depresja ST.

#Model nie bior¹cy pod uwagê zale¿noœci pomiêdzy wszystkimi zmiennymi
```{r}
model.model= lm(heart$wiek~`max tetno`+cholesterol, heart)
summary(model.model)
```

Wnioski i obserwacje:

B³¹d standardowy reszt jest mniejszy w pierwszym modelu o nazwie "model" i wynosi 7.884 lat, natomiast w modelu "model.model" b³¹d standardowy reszt wynosi 8.159 lat i wspó³czynnik determinacji jest sporo mniejszy w drugim modelu. Mo¿emy stwierdziæ, ¿e model o nazwie "model.model" nie jest lepszy. Szukamy dalej bardziej dopasowanego modelu do naszych danych. 

#Analiza wariancji

Mo¿emy staraæ siê przewidywaæ wartoœæ zmiennej wiek za pomoc¹ zmiennej
cukier. Mo¿e doprowadziæ nas to do pewnych wniosków, np takich ,¿e im cz³owiek jest starszy tym jego podatnoœæ na cukrzyce wzrasta. 

Zwróæmy jednak uwagê na istotn¹ ró¿nicê w stosunku do regresji prostej. Mianowicie, zmienna cukier nie jest liczbowa. W takiej sytuacji, gdy zmienn¹ numeryczn¹ przewidujemy za pomoc¹ zmiennej kategorycznej, mówimy, ¿e mamy do czynienia z analiz¹ wariancji(ANOVA).

Hipoteza Ho:

Model i model.model nie ró¿ni¹ siê statystycznie.
```{r}
model1 = lm(heart$wiek~cholesterol+`max tetno`+cisnienie, heart)
model.model1 = lm(heart$wiek~cholesterol*`max tetno`*cisnienie, heart)
anova(model1,model.model1)

```

Wnioski i obserwacje:

P-value jest ma³e wiêc nie akceptujemy hipotezy Ho.

#Analiza kowariancji

Zmienn¹ numeryczn¹ mo¿emy wyjaœniaæ za pomoc¹ innej zmiennej
numerycznej i zmiennej kategorycznej jednoczeœnie.

Jakie mamy predyktory?

Jednym z dobrych predyktorów wieku osoby jest cisnienie. Rzecz jasna, ¿e osoby  starsze maj¹ wiêksze ciœnienie ni¿ osoby m³odsze.


```{r}
library(ggplot2)
ggplot(heart, aes(x =cisnienie,y = wiek)) + geom_point() 

heart %>% filter(!is.na(cisnienie) & !is.na(wiek)) %>%
summarise(correlation = cor(cisnienie, wiek))
```

Wnioski i obserwacje:

Widzimy, ¿e wspó³czynnik korelacji jest istotny i wynosi oko³o 0.3, jednak¿e nie jest bardzo du¿y, co sugeruje, ¿e na wiek wp³ywaj¹ równie¿ inne czynniki.


# Korelacje wieku z innymi zmiennymi numerycznymi

```{r}
library(GGally)
ggpairs(heart %>% select_if(is.numeric))

```

Wnioski i obserwacje:

Mo¿emy zauwa¿yæ, ¿e dobrym predyktorem jest równie¿ cholesterol (wspó³czynnik korelacji ponad 0.2), depresja ST (wspo³czynik korelacji 0.21) i max tetno (wspolczynnik oko³o -0.4).

#Dwa modele liniowe i i ich porównanie
```{r}
model.cisnienie<-lm(wiek~cisnienie,heart)
model.cukier<-lm(wiek~cukier,heart)
model.cs<-lm(wiek~cukier+cisnienie,heart)
summary(model.cisnienie)
summary(model.cukier)
summary(model.cs)

```

Wnioski i obserwacje:

Jak mo¿na by³o oczekiwaæ model zawieraj¹cy dwie zmienne niezale¿ne jest
lepiej dopasowany od modeli z pojedynczymi zmiennymi. Wspó³czynnik determinacji w modelu z dwoma zmiennymi niezale¿nymi wynosi oko³o 8%. W modelach z pojedyñcz¹ zmienn¹ du¿o mniej.

#Jaki procent wariancji wyjaœnia model?

```{r}
ggplot(heart %>% filter(!is.na(cukier)), aes(x = cukier, y = wiek)) +
geom_boxplot(notch = TRUE)
```

Wnioski i obserwacje:

Model z dwoma zmiennymi wyjaœnia oko³o 8% wariancji wieku osoby badanej. Widzimy, ¿e to czy ktoœ jest cukrzykiem czy nie zale¿y od wieku.


#Model o najwiêkszej zdolnoœci predykcji

Za³o¿enia: Staramy siê, by model by³ jak najprostszy, gdy¿ nie
zale¿y nam by dopasowa³ siê za dobrze do naszych danych.

Jednym z typowych kryteriów u¿ywanych do wyboru modelu jest zmodyfikowany wspó³czynnik determinacji. Zawiera on w sobie
informacjê o liczbie parametrów. Nie zawsze roœnie przy bardziej skomplikowanych modelach. Lepsz¹ metod¹ jest tzw. kryterium
informacyjne. AIC sprawdza siê dobrze w modelach predykcyjnych.

Rozwa¿ymy pe³ny model, z wszystkimi mo¿liwymi interakcjami.


```{r}
model.full<-lm(wiek~bol*cisnienie*cholesterol*`max tetno`*`depresja ST`+cukier*dusznica,na.omit(heart))
summary(model.full)
```

Wnioski i obserwacje:

Wiêkszoœæ zmiennych jest nieistotna statystycznie. Jest tak dlatego, ¿e informacja zosta³a podzielona pomiêdzy mnóstwo predyktorów i interakcji pomiêdzy nimi.

Stwórzmy sensowniejszy model.
Dodajemy wszystkie dostêpne zmienne. A zw³aszcza zmienn¹ cisnienie, zmienn¹ max tetno i zmienn¹ cholesterol. S¹ one najbardziej skorelowane ze zmienn¹ wiek.

```{r}
model.zlozony <-lm(wiek~cholesterol+cisnienie+spo.wyn+`depresja ST`+`max tetno`+bol+dusznica+cukier:cisnienie,na.omit(heart))
summary(model.zlozony)


```


Uproœæmy teraz model przy u¿yciu AIC.
```{r}
model.zlozony.aic <- step(model.zlozony)
```

Wnioski i obserwacje:

Jak widzimy aby model by³ dok³adniejszy wymagane by³o usuniêcie zmiennych depresja ST, cukier i spo.wyn. Ponadto wybrany model okaza³ siê mieæ ni¿sze AIC ni¿ model pe³ny.

```{r}
extractAIC(model.full)
extractAIC(model.zlozony.aic)
```

Wnioski i obserwacje:

ZnaleŸliœmy najlepiej dopasowany model do naszych danych. Jest to model.zlozony.aic.

#Wykresy diagnostyczne najlepszego modelu

Pierwszy wykres przedstawia reszty wykreœlone wglêdem wartoœci dopasowanych. Punkty powinny byæ równomiernie rozrzucone wzglêdem osi `x`. Czerwona linia (wyg³adzenie) wskazuje na lekkie niedopasowane modelu dla mniejszych wartoœci. 

Drugim wykresem jest wykres kwantyl-kwantyl standaryzowanych reszt. Reszty standaryzowane, s¹ to reszty podzielone przez odchylenie standardowe:
$$t_i = \frac{e_i}{s \sqrt{1 - h_{ii}} }$$
Wykres kwantyl-kwantyl powinien przypominaæ liniê prost¹. Tutaj widzimy pewne niedopasowanie w przypadku bardziej ekstremalnych obserwacji. 

Trzeci wykres jest wygodny do badania homoskedastycznoœci (czerwona krzywa powinna byæ jak najbardziej pozioma).

Czwarty wykres s³u¿y do badania, które obserwacje s¹ wp³ywowe. Uwidoczniona jest na nim odleg³oœæ Cooka, która bada ró¿nicê predykcji modelu wyjœciowego z modelem po usuniêciu obserwacji. Mo¿na udowodniæ, ¿e wyra¿a siê ona wzorem
$$C_i = e_i \left( \frac{n-p}{p} \cdot\frac{h_{ii}}{1 - h_{ii}} \right)^{1/2} $$

```{r}
plot(model.zlozony.aic)
```



